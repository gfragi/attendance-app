services:
  app:
    # use image or build locally
    build: .
    #image: ghcr.io/gfragi/attendance-app:latest
    env_file: [ ./.env.prod ]
    restart: unless-stopped
    volumes: [ ./data:/data ]
    expose: [ "8501" ]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8501/_stcore/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 30
      start_period: 20s
    # optional hardening
    # deploy:
    #   resources:
    #     limits: { memory: 512M, cpus: "0.50" }

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    env_file: [ ./.env.prod ]
    restart: unless-stopped
    command:
      - --provider=google
      - --http-address=0.0.0.0:4180
      - --upstream=http://app:8501
      - --email-domain=hua.gr
      - --redirect-url=https://attendances.ditapps.hua.gr/oauth2/callback
      - --cookie-secure=true
      - --cookie-samesite=lax
      - --cookie-expire=8h
      - --cookie-refresh=1h
      - --set-authorization-header=true
      - --pass-authorization-header=true
      - --pass-user-headers=true
      # optional but can help with some proxies:
      # - --reverse-proxy=true
      - --cookie-domain=attendances.ditapps.hua.gr
    ports: [ "10.100.59.105:8080:4180" ]
    depends_on:
      app:
        condition: service_started
