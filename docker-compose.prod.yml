services:
  app:
    build: .
    working_dir: /app
    env_file: [ ./.env.prod ]
    environment:
      AUTH_MODE: "proxy"
      PUBLIC_BASE_URL: "https://attendances.ditapps.hua.gr"
      DATABASE_URL: "sqlite:////data/attendance.db"
      PYTHONUNBUFFERED: "1"
      DEBUG_MODE: "true"
    restart: unless-stopped
    volumes: 
      - ./data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    expose: 
      - "8501"

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    restart: unless-stopped
    command:
      - --provider=google
      - --http-address=0.0.0.0:4180
      - --upstream=http://app:8501
      - --email-domain=hua.gr
      - --redirect-url=https://attendances.ditapps.hua.gr/oauth2/callback
      - --cookie-secure=true
      - --cookie-samesite=lax
      - --cookie-expire=4h
      - --cookie-refresh=1h
      - --set-xauthrequest=true
      - --pass-user-headers=true
      - --pass-authorization-header=false
      - --skip-jwt-bearer-tokens=true
      - --cookie-domain=attendances.ditapps.hua.gr
      - --skip-provider-button=true
      - --scope=openid profile email
      - --client-id=${OAUTH2_PROXY_CLIENT_ID}
      - --client-secret=${OAUTH2_PROXY_CLIENT_SECRET}
      - --cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET}
    environment:
      # ONLY the essential variables, no conflicting ones
      OAUTH2_PROXY_CLIENT_ID: "${OAUTH2_PROXY_CLIENT_ID}"
      OAUTH2_PROXY_CLIENT_SECRET: "${OAUTH2_PROXY_CLIENT_SECRET}"
      OAUTH2_PROXY_COOKIE_SECRET: "${OAUTH2_PROXY_COOKIE_SECRET}"
    ports:
      - "10.100.59.214:30090:4180"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4180/oauth2/sign_in || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      app:
        condition: service_healthy