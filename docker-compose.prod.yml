services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: attendance
      POSTGRES_USER: attendance
      POSTGRES_PASSWORD: CHANGE_ME
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U attendance -d attendance"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  app:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env.prod
    environment:
      # override αν δεν θες να βάλεις credentials στο .env
      # DATABASE_URL: postgresql+psycopg2://attendance:CHANGE_ME@postgres:5432/attendance
      STREAMLIT_SERVER_HEADLESS: "true"
      STREAMLIT_SERVER_ENABLECORS: "false"
      STREAMLIT_SERVER_ENABLEXSRSFPROTECTION: "false"
    expose:
      - "8501"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 5s
      retries: 3

#   # Caddy reverse proxy με αυτόματο HTTPS
#   caddy:
#     image: caddy:2
#     depends_on:
#       - app
#     ports:
#       - "80:80"
#       - "443:443"
#     volumes:
#       - caddydata:/data
#       - caddyconfig:/config
#     environment:
#       DOMAIN: attendance.example.edu
#     command: |
#       caddy reverse-proxy --from ${DOMAIN} --to app:8501

# volumes:
#   pgdata:
#   caddydata:
#   caddyconfig:
