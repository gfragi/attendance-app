# map for Upgrade header handling (fixes: unknown "connection_upgrade")
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream app {
  server app:8501;
}

upstream oauth2_proxy {
  server oauth2-proxy:4180;
}

server {
  listen 80;
  server_name localhost;

  # --- oauth2-proxy endpoints are passed through ---
  location /oauth2/ {
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http;
    proxy_pass http://oauth2_proxy;
  }

  # auth subrequest (used by auth_request below)
  location = /oauth2/auth {
    proxy_pass http://oauth2_proxy;
  }

  # --- protect the app ---
  location / {
    # Call oauth2-proxy to verify login
    auth_request /oauth2/auth;

    # Pull identity from oauth2-proxy response headers
    auth_request_set $auth_email $upstream_http_x_auth_request_email;
    auth_request_set $auth_user  $upstream_http_x_auth_request_user;

    # Build query string we send to Streamlit: <original args> + sso_*
    set $augmented_args $args;
    if ($auth_email != "") { set $augmented_args "${augmented_args}&sso_email=${auth_email}"; }
    if ($auth_user  != "") { set $augmented_args "${augmented_args}&sso_name=${auth_user}";  }

    # Normal proxy headers
    proxy_http_version 1.1;
    proxy_set_header Upgrade           $http_upgrade;
    proxy_set_header Connection        $connection_upgrade;

    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto http;

    # ðŸš© The key line: pass URI with our augmented query string
    proxy_pass http://app$uri?$augmented_args;
  }

  # Optional: lightweight health check
  location = /healthz {
    return 200 "ok\n";
  }
}
