map $http_upgrade $connection_upgrade { default upgrade; '' close; }
map $args $qs_sep { "" "?"; default "&"; }


upstream app       { server app:8501; }
upstream oauth2_pr { server oauth2-proxy:4180; }

# HTTP -> HTTPS: send to 8443
server {
  listen 80;
  server_name localhost;
  return 301 https://$host:8443$request_uri;
}

# HTTPS on 8443
server {
  listen 8443 ssl;
  server_name localhost;

  ssl_certificate     /etc/nginx/certs/localhost.pem;
  ssl_certificate_key /etc/nginx/certs/localhost-key.pem;

  # if auth_request says 401 → go to oauth2 start
  error_page 401 = @oauth2_signin;
  location @oauth2_signin {
    return 302 https://$host:8443/oauth2/start?rd=https://$host:8443$request_uri;
  }

  # oauth2-proxy UI/flows
  location /oauth2/ {
    proxy_pass http://oauth2_pr;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  https;          # tell upstream we’re HTTPS
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Port   8443;
  }

  # internal auth endpoint for auth_request
  location = /oauth2/auth {
    internal;
    proxy_pass http://oauth2_pr/oauth2/auth;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_set_header X-Forwarded-Host   $host;
    proxy_set_header X-Forwarded-Port   8443;
    proxy_set_header X-Original-URI     $request_uri;
    proxy_pass_request_body off;
    proxy_set_header Content-Length     "";
  }

  location = /oauth2/userinfo {
    proxy_pass http://oauth2_pr/oauth2/userinfo;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Port  8443;
  }
  # app (protected)
  location / {
  auth_request /oauth2/auth;

  proxy_set_header X-Auth-Request-User  $upstream_http_x_auth_request_user;
  proxy_set_header X-Auth-Request-Email $upstream_http_x_auth_request_email;

  proxy_set_header Upgrade    $http_upgrade;
  proxy_set_header Connection $connection_upgrade;
  proxy_set_header Host              $host;
  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Port  8443;

  proxy_http_version 1.1;
  proxy_read_timeout 3600;
  proxy_send_timeout 3600;

  proxy_pass http://app;
}



  # --- Streamlit WebSocket: keep it alive and unbuffered ---
location /_stcore/stream {
  auth_request /oauth2/auth;
  proxy_pass http://app;
  proxy_http_version 1.1;
  proxy_set_header Upgrade "websocket";
  proxy_set_header Connection "upgrade";
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header X-Forwarded-Host  $host;
  proxy_set_header X-Forwarded-Port  8443;
  proxy_read_timeout 86400;
  proxy_send_timeout 86400;
  proxy_buffering off;
  proxy_cache_bypass $http_upgrade;
}

# (Optional but nice: route other Streamlit internals explicitly)
location /_stcore/ {
  auth_request /oauth2/auth;
  auth_request_set $user  $upstream_http_x_auth_request_user;
  auth_request_set $email $upstream_http_x_auth_request_email;

  set $needs_qs 0;
  if ($arg_sso_email = "") { set $needs_qs 1; }
  if ($email = "")         { set $needs_qs 0; }

  if ($needs_qs) {
    set $redir "https://$host:8443$uri$qs_sep";
    set $redir "${redir}sso_email=$email";
    return 302 $redir;
  }

  proxy_pass http://app;
  proxy_set_header Host               $host;
  proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto  https;
  proxy_set_header X-Forwarded-Host   $host;
  proxy_set_header X-Forwarded-Port   8443;
}
}