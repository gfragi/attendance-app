services:
  app:
    # use image or build locally
    build: .
    #image: ghcr.io/gfragi/attendance-app:latest
    working_dir: /app
    env_file: [ ./.env.prod ]
    environment:
      AUTH_MODE: "proxy"
      PUBLIC_BASE_URL: "https://attendances.ditapps.hua.gr"
      DATABASE_URL: "sqlite:////data/attendance.db"
      PYTHONUNBUFFERED: "1"
      DEBUG_MODE: "false"  # Set to "true" when debugging needed
    restart: unless-stopped
    volumes: 
      - ./data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    expose: 
      - "8501"
    # optional hardening
    # deploy:
    #   resources:
    #     limits: { memory: 512M, cpus: "0.50" }

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    environment:
      # OAuth Configuration
      OAUTH2_PROXY_PROVIDER: "google"
      OAUTH2_PROXY_CLIENT_ID: "${OAUTH2_PROXY_CLIENT_ID}"
      OAUTH2_PROXY_CLIENT_SECRET: "${OAUTH2_PROXY_CLIENT_SECRET}"
      OAUTH2_PROXY_COOKIE_SECRET: "${OAUTH2_PROXY_COOKIE_SECRET}"
      
      # Domain restriction
      OAUTH2_PROXY_EMAIL_DOMAINS: "hua.gr"
      
      # URLs
      OAUTH2_PROXY_REDIRECT_URL: "https://attendances.ditapps.hua.gr/oauth2/callback"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      
      # Headers - CRITICAL FIXES
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "false"
      
      # Cookie settings - IMPORTANT FIXES
      OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_HTTPONLY: "true"
      OAUTH2_PROXY_COOKIE_REFRESH: "1h"
      OAUTH2_PROXY_COOKIE_EXPIRE: "4h"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_COOKIE_DOMAIN: "attendances.ditapps.hua.gr"
      
      # UI
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"

      # Whitelist
      OAUTH2_PROXY_WHITELIST_DOMAINS: "attendances.ditapps.hua.gr"

      # Scope
      OAUTH2_PROXY_SCOPE: "openid profile email"

      # Additional reliability settings
      OAUTH2_PROXY_UPSTREAMS: "http://app:8501/"
      OAUTH2_PROXY_SKIP_AUTH_PREFLIGHT: "true"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4180/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - "4180"
    restart: unless-stopped
    depends_on:
      app:
        condition: service_started