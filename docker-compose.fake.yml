services:
  app:
    image: python:3.11-slim
    working_dir: /app
    command: >
      bash -lc "pip install --no-cache-dir -r requirements.txt &&
                streamlit run Home.py --server.port 8501 --server.address 0.0.0.0"
    volumes:
      - ./app:/app
      - ./data:/data
    environment:
      AUTH_MODE: "proxy"
      PUBLIC_BASE_URL: "https://localhost:8443"
      DATABASE_URL: "sqlite:////data/attendance.db"
      PYTHONUNBUFFERED: "1"
    expose:
      - "8501"

  # oauth2-proxy sitting in front of Google
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0
    env_file:
      - ./.env
    environment:
      OAUTH2_PROXY_PROVIDER: ${OAUTH2_PROXY_PROVIDER}
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_PROXY_CLIENT_SECRET}
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_PROXY_COOKIE_SECRET}
      OAUTH2_PROXY_EMAIL_DOMAINS: "hua.gr"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"         # <-- emit X-Auth-Request-* headers
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      OAUTH2_PROXY_REDIRECT_URL: "https://localhost:8443/oauth2/callback"  # local https
      OAUTH2_PROXY_COOKIE_SECURE: "true"           # local https
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_WHITELIST_DOMAINS: "localhost:8443"

    expose:
      - "4180"

  nginx:
    image: nginx:alpine
    ports:
      - "8082:80"
      - "8443:8443"                # local https port
    volumes:
      - ./nginx/app.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - app
      - oauth2-proxy
